? my $channel = $_[0]->{handler}->args->[0];
? my $mxhr = $_[0]->{handler}->request->param('mxhr');
<html>
<head>
<title>Tatsumaki Chat demo</title>
<script src="/static/jquery-1.3.2.min.js"></script>
? if ($mxhr) {
<script src="/static/DUI.js"></script>
<script src="/static/Stream.js"></script>
? } else {
<script src="/static/jquery.ev.js"></script>
? }
<script src="/static/jquery.md5.js"></script>
<script src="/static/jquery.cookie.js"></script>
<script>
var cookieName = 'tatsumaki_chat_ident';
function doPost(el1, el) {
  var ident = el1.attr('value');
  if (ident) $.cookie(cookieName, ident, { path: '/chat' });
  var text = el.attr('value');
  if (!text) return;
  $.ajax({
    url: "/chat/<?= $channel ?>/post",
    data: { ident: ident, text: text },
    type: 'post',
    dataType: 'json',
    success: function(r) { }
  });
  el.attr('value', '');
  return;
}

$(function(){
  var onNewEvent = function(e) {
    try {
      var avatar = e.avatar || ("http://www.gravatar.com/avatar/" + $.md5(e.ident || 'foo'));
      var name   = e.name   || e.ident || 'Anonymous';
      var img = $('<img/>').attr('src', avatar).attr('alt', name).addClass('avatar');
      if (e.ident) {
        var link = e.ident.match(/https?:/) ? e.ident : 'mailto:' + e.ident;
        img = $('<a/>').attr('href', link).attr('target', '_blank').append(img);
      }
      $('#messages').prepend(
        $('<li class="message"/>').text(e.text).prepend(img)
          .append($('<span/>').addClass('meta').text(' (' + e.time + ' from ' + e.address + ')'))
      );
    } catch(e) { if (console) console.log(e) };
  }

  if (typeof DUI != 'undefined') {
    var s = new DUI.Stream();
    s.listen('application/json', function(payload) {
      var event = eval('(' + payload + ')');
      onNewEvent(event);
    });
    s.load('/chat/<?= $channel ?>/mxhrpoll?session=' + Math.random());
  } else {
    $.ev.handlers.message = onNewEvent;
    $.ev.loop('/chat/<?= $channel ?>/poll?session=' + Math.random());
  }

  if ($.cookie(cookieName))
    $('#ident').attr('value', $.cookie(cookieName));
  $.ajax({
    url: '/chat/<?= $channel ?>/backlog?' + Math.random(),
    method: 'get',
    dataType: 'json',
    success: function(r) {
      $.each(r, function(i, e) {
        onNewEvent(e);
      });
    }
  });
});
</script>
<link rel="stylesheet" href="/static/screen.css" />
<style>
ul#messages {
  list-style-type: none;
  margin-top: 1em;
}
img.avatar {
  width: 25px; height: 25px;
  vertical-align: middle;
  margin-right: 0.5em;
}
.message {
  margin-top: 0.5em;
}
.meta {
  color: #888;
  font-size: 0.8em;
}
body {
  margin: 1em 2em
}

</style>
</head>
<body>
<h1 class="chat-room-name">Chat room: <?= $channel ?></h1>
<!-- move this input out of form so Firefox can submit with enter key :/ -->
Your email (for Gravatar): <input id="ident" type="text" name="ident" size="24"/>
<form onsubmit="doPost($('#ident'), $('#chat')); return false">
Something to say: <input id="chat" type="text" size="48"/>
</form>

<ul id="messages">
</ul>

<div id="footer">Powered by <a href="http://github.com/miyagawa/Tatsumaki">Tatsumaki/<?= $Tatsumaki::VERSION ?></a>.</div>

</body>
</html>